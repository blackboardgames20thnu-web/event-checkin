<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Manager Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Kanit', sans-serif; background: #f8f9fa; padding: 10px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
        .nav button { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; background: #ddd; white-space: nowrap; }
        .nav button.active { background: #007bff; color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .btn-del { color: red; cursor: pointer; }
        #reader { width: 100%; max-width: 400px; margin: auto; }
    </style>
</head>
<body>

<div class="nav">
    <button onclick="showPage('scan')" id="btn-scan" class="active">สแกนเข้างาน</button>
    <button onclick="showPage('reg')">เพิ่ม/นำเข้าชื่อ</button>
    <button onclick="showPage('list'); loadList();">ประวัติ/จัดการ</button>
</div>

<div id="page-scan" class="card">
    <h3>สแกน QR Code (มีเสียง)</h3>
    <div id="reader"></div>
    <div id="scan-res" style="text-align:center; padding:15px; font-weight:bold;"></div>
</div>

<div id="page-reg" class="card" style="display:none;">
    <h3>เพิ่มรายชื่อ</h3>
    <input type="text" id="in-id" placeholder="ID">
    <input type="text" id="in-name" placeholder="ชื่อ">
    <input type="text" id="in-uni" placeholder="มหาวิทยาลัย">
    <button style="background:green; color:white; margin-top:10px;" onclick="addSingle()">บันทึกรายคน</button>
    <hr>
    <h3>นำเข้าจาก Excel (.xlsx)</h3>
    <input type="file" id="excel-file" accept=".xlsx, .xls">
    <p><small>*คอลัมน์ต้องเรียงเป็น ID, Name, University</small></p>
</div>

<div id="page-list" class="card" style="display:none;">
    <h3>รายชื่อทั้งหมด</h3>
    <div style="overflow-x:auto;">
        <table id="data-table">
            <thead><tr><th>ID</th><th>ชื่อ</th><th>สถานะ</th><th>จัดการ</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<audio id="beep" src="https://www.soundjay.com/button/beep-07.wav"></audio>

<script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzvyeuPVVKbW-ZgqDZ3Et9wtijIP484juSUkyI25plI6HDZ5U26MEv9E34UvTQvnhyH/exec";
    const beep = document.getElementById("beep");

    function showPage(p) {
        document.querySelectorAll('[id^="page-"]').forEach(el => el.style.display = 'none');
        document.getElementById('page-' + p).style.display = 'block';
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    }

    // ฟังก์ชันสแกน
    function onScanSuccess(txt) {
        beep.play(); // ดังตี๊ด
        document.getElementById('scan-res').innerText = "กำลังตรวจ: " + txt;
        html5QrcodeScanner.pause();
        fetch(`${webAppUrl}?id=${txt}`)
            .then(r => r.text())
            .then(d => {
                alert(d);
                html5QrcodeScanner.resume();
            });
    }
    var html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);

    // โหลดประวัติและจัดการ
    function loadList() {
        const tbody = document.querySelector("#data-table tbody");
        tbody.innerHTML = "กำลังโหลด...";
        fetch(`${webAppUrl}?action=getList`)
            .then(r => r.json())
            .then(data => {
                tbody.innerHTML = "";
                data.forEach(item => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.name}</td>
                            <td>${item.status}</td>
                            <td>
                                <small onclick="viewQr('${item.id}')" style="color:blue; cursor:pointer;">QR</small> | 
                                <small onclick="delRow(${item.row})" class="btn-del">ลบ</small>
                            </td>
                        </tr>`;
                });
            });
    }

    function viewQr(id) {
        window.open(`https://quickchart.io/qr?text=${id}&size=300`);
    }

    function delRow(row) {
        if(confirm("ยืนยันการลบ?")) {
            fetch(`${webAppUrl}?action=delete&row=${row}`).then(() => loadList());
        }
    }

    // นำเข้า Excel
    document.getElementById('excel-file').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            
            alert("กำลังนำเข้า " + (json.length-1) + " รายชื่อ...");
            json.forEach((row, index) => {
                if(index > 0 && row[0]) { // ข้ามหัวตาราง
                    fetch(`${webAppUrl}?action=register&id=${row[0]}&name=${encodeURIComponent(row[1])}&uni=${encodeURIComponent(row[2])}`);
                }
            });
            alert("ดำเนินการเสร็จสิ้น (ข้อมูลอาจใช้เวลาสักครู่เพื่อไปโผล่ที่ตาราง)");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function addSingle() {
        const id = document.getElementById('in-id').value;
        const name = document.getElementById('in-name').value;
        const uni = document.getElementById('in-uni').value;
        fetch(`${webAppUrl}?action=register&id=${id}&name=${encodeURIComponent(name)}&uni=${encodeURIComponent(uni)}`)
            .then(() => alert("บันทึกสำเร็จ"));
    }
</script>
</body>
</html>
