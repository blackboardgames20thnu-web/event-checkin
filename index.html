<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Event Pro - Ultimate System</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --main: #6366f1; --accent: #a5b4fc; --bg: #0f172a; --glass: rgba(30, 41, 59, 0.7); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: #f8fafc; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
        .header { padding: 25px 20px; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .container { padding: 15px; max-width: 800px; margin: auto; }
        .card { background: var(--glass); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 20px; margin-bottom: 20px; display: none; }
        .card.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; border: none !important; box-shadow: 0 0 25px rgba(99, 102, 241, 0.2); }
        input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px; border: 1px solid #334155; background: #1e293b; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.2s; background: var(--main); color: white; margin-bottom: 10px; }
        .nav { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 35px; display: flex; padding: 6px; gap: 4px; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .nav-item { border: none; background: none; color: #94a3b8; padding: 12px 18px; border-radius: 30px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 13px; white-space: nowrap; }
        .nav-item.active { background: var(--main); color: white; }
        .live-entry { background: linear-gradient(90deg, #4f46e5 0%, #7c3aed 100%); padding: 25px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; animation: flipIn 0.6s ease-out; }
        @keyframes flipIn { from { opacity: 0; transform: rotateX(-30deg) translateY(20px); } to { opacity: 1; transform: rotateX(0deg) translateY(0); } }
        #status-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 80%; max-width: 300px; padding: 15px; border-radius: 16px; text-align: center; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="status-toast"></div>

<div class="header">
    <h1><i class="fas fa-bolt" style="color:#fbbf24"></i> Event <span style="color:var(--main)">Pro Max</span></h1>
    <p>‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‚Ä¢ ‡∏î‡∏π QR ‚Ä¢ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏¢‡∏Å‡∏ä‡∏∏‡∏î</p>
</div>

<div class="container">
    <div id="page-scan" class="card active">
        <div id="reader"></div>
        <p style="text-align:center; color:#94a3b8; margin-top:15px">‡πÄ‡∏•‡πá‡∏á QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≠‡πÇ‡∏ï‡πâ)</p>
    </div>

    <div id="page-reg" class="card">
        <h3><i class="fas fa-user-plus"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
        <input type="text" id="in-id" placeholder="‡∏£‡∏´‡∏±‡∏™ ID">
        <input type="text" id="in-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input type="text" id="in-uni" placeholder="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î / ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢">
        <button class="btn" onclick="addSingle()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
        <hr style="border:0; border-top:1px solid #334155; margin:20px 0">
        <p>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô Excel</p>
        <input type="file" id="excel-file">
    </div>

    <div id="page-list" class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
            <h3 style="margin:0"><i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</h3>
            <div style="display:flex; gap:10px">
                <button onclick="loadList()" style="background:none; border:none; color:var(--main); cursor:pointer"><i class="fas fa-sync"></i></button>
            </div>
        </div>
        <button class="btn" style="background:#059669; font-size:14px" onclick="downloadAllQRs()">
            <i class="fas fa-file-archive"></i> Download All QR Codes (ZIP)
        </button>
        <div id="history-list"></div>
    </div>

    <div id="page-live" class="card">
        <h2 style="text-align:center; color:var(--main);"><i class="fas fa-broadcast-tower"></i> Live Dashboard</h2>
        <div id="live-container">
            <div id="welcome-msg" style="text-align:center; padding:100px; color:#475569;">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô...</div>
        </div>
    </div>
</div>

<div class="nav">
    <button class="nav-item active" onclick="showPage('scan', this)"><i class="fas fa-camera"></i> Scan</button>
    <button class="nav-item" onclick="showPage('reg', this)"><i class="fas fa-plus"></i> Add</button>
    <button class="nav-item" onclick="showPage('list', this); loadList();"><i class="fas fa-list-ul"></i> List</button>
    <button class="nav-item" onclick="showPage('live', this); startLiveUpdate();"><i class="fas fa-desktop"></i> Live</button>
</div>

<audio id="beep" src="https://www.soundjay.com/button/beep-07.wav"></audio>

<script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzvyeuPVVKbW-ZgqDZ3Et9wtijIP484juSUkyI25plI6HDZ5U26MEv9E34UvTQvnhyH/exec";
    const beep = document.getElementById("beep");
    let isScanning = true;
    let liveInterval;
    let lastProcessedTime = new Date().getTime();
    let globalUserData = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ZIP

    function showPage(p, btn) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(p !== 'live') clearInterval(liveInterval);
    }

    function onScanSuccess(txt) {
        if (!isScanning) return;
        isScanning = false;
        beep.play();
        fetch(`${webAppUrl}?id=${encodeURIComponent(txt)}`)
            .then(r => r.text())
            .then(d => {
                Swal.fire({ title: d, icon: d.includes("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à") ? 'success' : 'error', timer: 1500, showConfirmButton: false });
                setTimeout(() => { isScanning = true; }, 1500);
            });
    }

    let scanner = new Html5QrcodeScanner("reader", { fps: 30, qrbox: 250 });
    scanner.render(onScanSuccess);

    // --- ‡∏£‡∏∞‡∏ö‡∏ö List & QR ---
    function loadList() {
        const listDiv = document.getElementById("history-list");
        listDiv.innerHTML = "Loading...";
        fetch(`${webAppUrl}?action=getList`)
            .then(r => r.json())
            .then(data => {
                globalUserData = data;
                listDiv.innerHTML = "";
                data.reverse().forEach(item => {
                    listDiv.innerHTML += `
                        <div style="background:#1e293b; padding:15px; border-radius:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center">
                            <div>
                                <div style="font-weight:700">${item.name}</div>
                                <div style="font-size:12px; color:#94a3b8">${item.id} ‚Ä¢ ${item.uni}</div>
                            </div>
                            <div style="display:flex; gap:12px; align-items:center">
                                <button onclick="viewQr('${item.id}', '${item.name}')" style="background:none; border:none; color:var(--accent); font-size:20px; cursor:pointer"><i class="fas fa-qrcode"></i></button>
                                <button onclick="deleteRow(${item.row})" style="background:none; border:none; color:#ef4444; cursor:pointer"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                });
            });
    }

    function viewQr(id, name) {
        Swal.fire({
            title: `‡∏Ñ‡∏∏‡∏ì ${name}`,
            imageUrl: `https://quickchart.io/qr?text=${encodeURIComponent(id)}&size=300`,
            imageWidth: 250,
            background: '#1e293b',
            color: '#fff'
        });
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ZIP (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å QR) ---
    async function downloadAllQRs() {
        if (globalUserData.length === 0) return Swal.fire("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô", "warning");
        
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ü‡∏•‡πå ZIP...', text: '‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        
        const zip = new JSZip();
        const promises = globalUserData.map(async (user) => {
            const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(user.id)}&size=500`;
            const response = await fetch(qrUrl);
            const blob = await response.blob();
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∑‡πà‡∏≠ "ID_‡∏ä‡∏∑‡πà‡∏≠.png"
            zip.file(`${user.id}_${user.name}.png`, blob);
        });

        await Promise.all(promises);
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "Event_QR_Codes.zip");
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ZIP ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success");
        });
    }

    function deleteRow(row) {
        if(confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ?")) fetch(`${webAppUrl}?action=delete&row=${row}`).then(() => loadList());
    }

    function addSingle() {
        const id = document.getElementById('in-id').value;
        const name = document.getElementById('in-name').value;
        const uni = document.getElementById('in-uni').value;
        fetch(`${webAppUrl}?action=register&id=${id}&name=${encodeURIComponent(name)}&uni=${encodeURIComponent(uni)}`).then(() => {
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", "success");
            loadList();
        });
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Excel ---
    document.getElementById('excel-file').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            for(let i = 1; i < json.length; i++) {
                if(json[i][0]) await fetch(`${webAppUrl}?action=register&id=${json[i][0]}&name=${encodeURIComponent(json[i][1])}&uni=${encodeURIComponent(json[i][2]||"")}`);
            }
            Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", "success");
            loadList();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    // --- ‡∏£‡∏∞‡∏ö‡∏ö Live Display ---
    function startLiveUpdate() {
        if (liveInterval) clearInterval(liveInterval);
        liveInterval = setInterval(() => {
            fetch(`${webAppUrl}?action=getList`)
                .then(r => r.json())
                .then(data => {
                    const latest = data.filter(i => i.status === "Checked In" && i.time)
                                      .sort((a, b) => new Date(b.time) - new Date(a.time))[0];
                    if (latest) {
                        const checkTime = new Date(latest.time).getTime();
                        if (checkTime > lastProcessedTime) {
                            renderLive(latest);
                            lastProcessedTime = checkTime;
                        }
                    }
                });
        }, 3000);
    }

    function renderLive(user) {
        const container = document.getElementById('live-container');
        const welcome = document.getElementById('welcome-msg');
        if (welcome) welcome.remove();
        const entry = document.createElement('div');
        entry.className = 'live-entry';
        entry.innerHTML = `<div><div style="font-size:32px; font-weight:800; color:#fff">${user.name}</div><div style="font-size:18px; color:#a5b4fc">${user.uni}</div></div><div style="font-size:40px">üëã</div>`;
        container.insertBefore(entry, container.firstChild);
        if (container.children.length > 5) container.lastChild.remove();
        const msg = new SpeechSynthesisUtterance(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${user.name}`);
        msg.lang = 'th-TH';
        window.speechSynthesis.speak(msg);
    }
</script>
</body>
</html>
