<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Manager Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #4361ee; --success: #4cc9f0; --dark: #3f37c9; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding-bottom: 70px; }
        
        /* Header & Navigation */
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { border: none; background: none; color: #888; font-size: 12px; cursor: pointer; transition: 0.3s; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 5px; }
        .nav-item.active { color: var(--primary); }

        /* Cards */
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: none; }
        .card.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Inputs & Buttons */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button.main-btn { width: 100%; padding: 15px; border: none; border-radius: 10px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        
        /* Table */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; }
        .bg-pending { background: #ffeeba; color: #856404; }
        .bg-success { background: #d4edda; color: #155724; }

        #reader { width: 100%; border-radius: 15px; overflow: hidden; border: none !important; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0">Event Dashboard</h2>
    <p style="margin:5px 0 0; opacity:0.8; font-size:12px">ระบบจัดการและสแกนเข้างาน</p>
</div>

<div class="container">
    <div id="page-scan" class="card active">
        <h3 style="margin-top:0"><i class="fas fa-qrcode"></i> Scan to Check-in</h3>
        <div id="reader"></div>
        <div id="scan-status" style="text-align:center; margin-top:15px; color:#666;">Ready to scan</div>
    </div>

    <div id="page-reg" class="card">
        <h3><i class="fas fa-user-plus"></i> เพิ่มผู้ร่วมงาน</h3>
        <input type="text" id="in-id" placeholder="รหัส ID">
        <input type="text" id="in-name" placeholder="ชื่อ-นามสกุล">
        <input type="text" id="in-uni" placeholder="มหาวิทยาลัย">
        <button class="main-btn" onclick="addSingle()">บันทึกรายชื่อ</button>
        
        <div style="margin: 20px 0; border-top: 1px solid #eee; padding-top: 20px;">
            <h4><i class="fas fa-file-excel"></i> นำเข้าผ่าน Excel</h4>
            <input type="file" id="excel-file" accept=".xlsx, .xls">
        </div>
    </div>

    <div id="page-list" class="card">
        <h3><i class="fas fa-history"></i> ประวัติและรายชื่อ</h3>
        <button onclick="loadList()" style="background:none; border:1px solid #ddd; padding:5px 10px; border-radius:5px; margin-bottom:10px;">
            <i class="fas fa-sync"></i> รีเฟรชข้อมูล
        </button>
        <div class="table-container">
            <table id="data-table">
                <thead><tr><th>ID/ชื่อ</th><th>สถานะ</th><th>จัดการ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="nav-bar">
    <button class="nav-item active" onclick="showPage('scan', this)"><i class="fas fa-camera"></i>สแกน</button>
    <button class="nav-item" onclick="showPage('reg', this)"><i class="fas fa-user-plus"></i>เพิ่มชื่อ</button>
    <button class="nav-item" onclick="showPage('list', this); loadList();"><i class="fas fa-list-ul"></i>รายชื่อ</button>
</div>

<audio id="beep" src="https://www.soundjay.com/button/beep-07.wav"></audio>

<script>
    const webAppUrl = "ใส่_URL_APPS_SCRIPT_ของคุณตรงนี้";
    const beep = document.getElementById("beep");
    let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: 250 });

    function showPage(p, btn) {
        document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        document.getElementById('page-' + p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // แก้ไขปัญหาการค้าง: ใช้ Swal และ Resume ทันทีที่ปิดหน้าต่าง
    function onScanSuccess(txt) {
        beep.play();
        html5QrcodeScanner.pause(true); // หยุดกล้องแบบแช่ภาพไว้
        
        document.getElementById('scan-status').innerHTML = `<i class="fas fa-spinner fa-spin"></i> กำลังตรวจ ID: ${txt}`;

        fetch(`${webAppUrl}?id=${encodeURIComponent(txt)}`)
            .then(r => r.text())
            .then(d => {
                Swal.fire({
                    title: d.includes("สำเร็จ") ? "สำเร็จ!" : "ไม่สำเร็จ",
                    text: d,
                    icon: d.includes("สำเร็จ") ? "success" : "error",
                    confirmButtonText: "ตกลง",
                    timer: 3000 // ปิดเองใน 3 วิถ้าไม่กด
                }).then(() => {
                    html5QrcodeScanner.resume();
                    document.getElementById('scan-status').innerText = "Ready to scan";
                });
            })
            .catch(err => {
                Swal.fire("ผิดพลาด", "การเชื่อมต่อล้มเหลว", "error").then(() => html5QrcodeScanner.resume());
            });
    }

    html5QrcodeScanner.render(onScanSuccess);

    function loadList() {
        const tbody = document.querySelector("#data-table tbody");
        tbody.innerHTML = "<tr><td colspan='3' style='text-align:center'>กำลังโหลด...</td></tr>";
        fetch(`${webAppUrl}?action=getList`)
            .then(r => r.json())
            .then(data => {
                tbody.innerHTML = "";
                data.reverse().forEach(item => { // ล่าสุดอยู่บน
                    const statusClass = item.status === "Checked In" ? "bg-success" : "bg-pending";
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${item.id}</strong><br>${item.name}</td>
                            <td><span class="badge ${statusClass}">${item.status}</span></td>
                            <td style="white-space:nowrap">
                                <button onclick="viewQr('${item.id}')" style="border:none; background:#e7f5ff; color:#0369a1; padding:5px; border-radius:5px;"><i class="fas fa-qrcode"></i></button>
                                <button onclick="delRow(${item.row})" style="border:none; background:#fff5f5; color:#c53030; padding:5px; border-radius:5px;"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                });
            });
    }

    function viewQr(id) {
        Swal.fire({
            title: 'QR Code สำหรับ ID: ' + id,
            imageUrl: `https://quickchart.io/qr?text=${encodeURIComponent(id)}&size=300`,
            imageWidth: 200,
            imageHeight: 200,
            confirmButtonText: 'ปิด'
        });
    }

    function delRow(row) {
        Swal.fire({
            title: 'ยืนยันการลบ?',
            text: "คุณจะไม่สามารถกู้คืนข้อมูลนี้ได้",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'ลบเลย',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`${webAppUrl}?action=delete&row=${row}`).then(() => {
                    Swal.fire('ลบแล้ว!', '', 'success');
                    loadList();
                });
            }
        });
    }

    function addSingle() {
        const id = document.getElementById('in-id').value;
        const name = document.getElementById('in-name').value;
        const uni = document.getElementById('in-uni').value;
        if(!id || !name) return Swal.fire("แจ้งเตือน", "กรุณากรอก ID และ ชื่อ", "warning");

        fetch(`${webAppUrl}?action=register&id=${id}&name=${encodeURIComponent(name)}&uni=${encodeURIComponent(uni)}`)
            .then(() => {
                Swal.fire("บันทึกสำเร็จ", "", "success");
                document.getElementById('in-id').value = "";
                document.getElementById('in-name').value = "";
            });
    }

    // ระบบ Excel Import (เพิ่มการแจ้งเตือนความคืบหน้า)
    document.getElementById('excel-file').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
            
            Swal.fire({ title: 'กำลังนำเข้า...', text: 'กรุณารอสักครู่', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            for(let i = 1; i < json.length; i++) {
                if(json[i][0]) {
                    await fetch(`${webAppUrl}?action=register&id=${json[i][0]}&name=${encodeURIComponent(json[i][1])}&uni=${encodeURIComponent(json[i][2]||"")}`);
                }
            }
            Swal.fire("สำเร็จ!", `นำเข้า ${json.length-1} รายชื่อเรียบร้อย`, "success");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });
</script>
</body>
</html>
